<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metalks - 认识你自己</title>
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/chat.css">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
</head>
<body>
    <div class="bg-cosmos">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
        <div class="grid-overlay"></div>
    </div>

    <div class="app-layout">
        <nav class="sidebar-nav">
            <div class="nav-header">
                <div class="logo">M</div>
            </div>
            
            <div class="nav-actions">
                <button class="nav-btn active" id="newChatBtn" title="新对话">
                    <i class="ri-add-line"></i>
                </button>
                <button class="nav-btn" id="historyToggleBtn" title="历史记录">
                    <i class="ri-history-line"></i>
                </button>
            </div>

            <div class="nav-footer">
                <button class="nav-btn" id="authBtn" title="用户">
                    <i class="ri-user-3-line"></i>
                </button>
            </div>
        </nav>

        <div class="history-drawer" id="historyDrawer">
            <div class="drawer-header">
                <h3>时光回溯</h3>
                <button class="icon-btn" id="closeHistoryBtn"><i class="ri-close-line"></i></button>
            </div>
            <ul class="session-list" id="sessionList">
                <div style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.3);">
                    加载中...
                </div>
            </ul>
        </div>

        <main class="chat-stage">
            <div class="chat-wrapper">
                <header class="stage-header">
                    <div class="header-info">
                        <span class="topic-badge" id="currentTopicTag">自由对话</span>
                        <h1 id="chatTitle">与自我对话</h1>
                    </div>
                    <div class="header-actions">
                        <button class="refresh-btn" id="refreshTopicsButton_Header">
                            <i class="ri-refresh-line"></i> 换个话题
                        </button>
                    </div>
                </header>

                <div class="messages-container" id="chatMessages">
                    <div class="welcome-placeholder" id="welcomePlaceholder">
                        <h2>准备好探索内心了吗？</h2>
                        <p>选择一个话题，或直接开始。</p>
                    </div>
                </div>

                <div class="input-dock">
                    <div class="input-glass">
                        <textarea 
                            id="chatInput" 
                            placeholder="写下你的想法..." 
                            rows="1"
                        ></textarea>
                        <button id="sendButton" class="send-btn">
                            <i class="ri-send-plane-fill"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <aside class="insight-hud">
            <div class="hud-card status-card">
                <div class="card-label">
                    <i class="ri-pulse-line"></i> 当前状态
                </div>
                <div class="status-content" id="statusContent">
                    等待连接...
                </div>
            </div>

            <div class="hud-card traits-card">
                <div class="card-header">
                    <div class="card-label">
                        <i class="ri-user-search-line"></i> 你的特质
                    </div>
                </div>
                <div class="traits-body" id="traitsContent">
                    随着对话深入，你的轮廓将逐渐清晰...
                </div>
                <a class="hud-link" id="traitsDetailLink">
                    查看深度解析 <i class="ri-arrow-right-line"></i>
                </a>
            </div>

            <div class="hud-card topic-mini" id="topicSelectorMini">
                <div class="card-label">当前话题</div>
                <div class="topic-display" id="currentTopic">未选择</div>
                <i class="ri-arrow-down-s-line icon-indicator"></i>
            </div>
        </aside>
    </div>

    <!-- 话题选择模态框 -->
    <div class="modal-overlay" id="topicOverlay">
        <div class="modal-glass">
            <div class="modal-header">
                <h2>你想聊点什么？</h2>
                <p class="subtitle">每一个话题都是通往潜意识的入口</p>
                <button class="refresh-icon-btn" id="refreshTopicsButton" title="刷新话题">
                    <i class="ri-refresh-line"></i>
                </button>
            </div>
            
            <div class="topics-grid" id="topicsGrid"></div>
            
            <div class="modal-footer">
                <button class="casual-btn" id="casualChatButton">
                    <i class="ri-cup-line"></i> 随便聊聊
                </button>
            </div>
        </div>
    </div>

    <!-- 报告查看模态框 -->
    <div class="modal-overlay" id="reportOverlay">
        <div class="modal-glass report-modal">
            <div class="modal-header">
                <h2 id="reportTitle">分析报告</h2>
                <button class="close-icon" id="closeReportButton"><i class="ri-close-line"></i></button>
            </div>
            <div class="report-scroll-area" id="reportContent" style="max-height: 60vh; overflow-y: auto; line-height: 1.8;">
            </div>
        </div>
    </div>

    <!-- 特质详情模态框 -->
    <div class="modal-overlay" id="traitsDetailOverlay">
        <div class="modal-glass report-modal">
            <div class="modal-header">
                <h2>思维特质图谱</h2>
                <button class="close-icon" id="closeTraitsDetailButton"><i class="ri-close-line"></i></button>
            </div>
            <div class="report-scroll-area" id="traitsDetailContent" style="max-height: 60vh; overflow-y: auto;">
            </div>
        </div>
    </div>

    <!-- 话题切换确认 -->
    <div class="modal-overlay" id="confirmOverlay">
        <div class="confirm-box">
            <h3>切换话题？</h3>
            <p id="confirmMessage" style="margin-bottom: 1.5rem; color: rgba(255,255,255,0.7);">当前对话将被保存至历史记录。</p>
            <div class="confirm-actions">
                <button class="btn-ghost" id="confirmNo">放弃</button>
                <button class="btn-primary" id="confirmYes">保存并切换</button>
            </div>
        </div>
    </div>

    <!-- 🆕 删除确认弹窗（优化版） -->
    <div class="modal-overlay" id="deleteConfirmOverlay">
        <div class="delete-confirm-box">
            <h3>删除聊天?</h3>
            <p class="warning-text">
                这会删除"<span id="deleteTopicName">实时视频通话实况</span>"。<br>
                访问<a id="dimgaaiLink" class="dimgaai-link">点解</a>以删除此聊天期间生成的观念报告。
            </p>
            <div class="delete-confirm-actions">
                <button class="btn-ghost" id="deleteConfirmNo">取消</button>
                <button class="btn-primary" id="deleteConfirmYes" style="background: var(--error-color);">删除</button>
            </div>
        </div>
    </div>

    <!-- 🆕 用户菜单弹窗 -->
    <div class="modal-overlay" id="userMenuOverlay">
        <div class="user-menu-popup">
            <div class="user-info">
                <div class="user-avatar">
                    <i class="ri-user-3-fill"></i>
                </div>
                <div class="user-email" id="userEmail">user@example.com</div>
            </div>
            <div class="menu-divider"></div>
            <button class="menu-item disabled" id="upgradeBtn">
                <i class="ri-vip-crown-line"></i>
                <span>订阅</span>
            </button>
            <button class="menu-item disabled" id="personalizeBtn">
                <i class="ri-settings-3-line"></i>
                <span>个性化</span>
            </button>
            <button class="menu-item" id="dimgaaiMenuBtn">
                <i class="ri-brain-line"></i>
                <span>点解</span>
            </button>
            <div class="menu-divider"></div>
            <button class="menu-item logout" id="logoutBtn">
                <i class="ri-logout-box-line"></i>
                <span>退出登录</span>
            </button>
        </div>
    </div>

    <!-- 🔧 更新公告弹窗 -->
    <div class="modal-overlay" id="updateOverlay">
        <div class="modal-glass" style="max-width: 500px;">
            <div class="modal-header">
                <h2>✨ 新版本更新</h2>
                <p class="subtitle" id="updateVersionDate">2025-12-29</p>
                <button class="close-icon" id="closeUpdateBtn"><i class="ri-close-line"></i></button>
            </div>
        
            <div class="report-scroll-area" id="updateContentBody" style="max-height: 40vh; margin-bottom: 2rem; line-height: 1.8;">
            </div>

            <div class="modal-footer">
                <button class="btn-primary" id="acknowledgeUpdateBtn" style="width: 100%;">
                    已阅，感谢开发组！
                </button>
            </div>
        </div>
    </div>
    <!-- 统一引入依赖链 -->
    <script type="module" src="../js/pages/main-chat.js"></script>

</body>
</html>