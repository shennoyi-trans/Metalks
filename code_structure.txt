# Metalks 项目完整文件结构
# 版本: v1.2.0
# 更新日期: 2025-01-12

项目根目录/
│
├── frontend/                           # 前端代码（静态资源）
│   ├── html/                           # HTML 页面
│   │   ├── chat.html                   # 主聊天页面
│   │   └── dimgaai.html                # 点解页面（特质&报告查看）
│   │
│   ├── css/                            # 样式文件
│   │   ├── common.css                  # 公共样式（变量、背景、模态框）
│   │   ├── chat.css                    # 聊天页面样式
│   │   └── dimgaai.css                 # 点解页面样式
│   │
│   ├── js/                             # JavaScript 脚本
│   │   ├── utils.js                    # 公共工具函数（API、认证、Toast）
│   │   ├── chat.js                     # 聊天页面逻辑
│   │   └── dimgaai.js                  # 点解页面逻辑
│   │
│   └── fonts/                          # 字体文件
│       ├── OPPO_Sans_4.0/              # OPPO Sans 字体
│       └── Alibaba_puhui/              # 阿里巴巴普惠体
│
│
├── backend/                            # 后端代码
│   │
│   ├── api/                            # API 路由层
│   │   ├── __init__.py
│   │   ├── auth_api.py                 # 认证接口（注册/登录/登出）
│   │   ├── user_api.py                 # 用户信息管理（个人资料/密码/昵称/电解液）
│   │   ├── chat_api.py                 # 聊天流式接口
│   │   ├── topic_api.py                # 话题查询接口
│   │   ├── traits_api.py               # 特质查询接口
│   │   ├── session_api.py              # 会话管理接口（列表/详情/删除）
│   │   └── report_api.py               # 报告查询接口（状态/内容）
│   │
│   ├── core/                           # 核心功能模块
│   │   ├── dependencies.py             # FastAPI 依赖注入（当前用户）
│   │   └── security.py                 # 安全相关（JWT/密码哈希）
│   │
│   ├── data/                           # 静态数据配置
│   │   └── topics.py                   # 话题配置列表
│   │
│   ├── db/                             # 数据库层
│   │   ├── __init__.py
│   │   ├── database.py                 # 数据库连接配置
│   │   ├── models.py                   # ORM 模型定义
│   │   │                               # - User（用户）
│   │   │                               # - Session（会话）
│   │   │                               # - Message（消息）
│   │   │                               # - TraitProfile（特质画像）
│   │   │                               # - SensitiveWord（敏感词）
│   │   │                               # - NicknameHistory（昵称历史）
│   │   │
│   │   └── crud/                       # CRUD 操作封装
│   │       ├── __init__.py             # 统一导入入口
│   │       ├── user.py                 # 用户 CRUD（查询/创建/更新/认证）
│   │       ├── nickname.py             # 昵称 CRUD（更新/历史记录）
│   │       └── electrolyte.py          # 电解液 CRUD（查询/增加/扣除）
│   │
│   ├── documents/                      # 项目文档
│   │   ├── code_structure.txt          # 代码结构说明
│   │   ├── prompt_structure.txt        # 提示词结构说明
│   │   └── 输出说明.txt                # API 输出格式说明
│   │
│   ├── llm_client/                     # LLM 调用层
│   │   ├── __init__.py
│   │   ├── base.py                     # LLM 客户端抽象基类
│   │   ├── deepseek_client.py          # DeepSeek API 客户端
│   │   ├── mock_client.py              # Mock 客户端（测试用）
│   │   └── factory.py                  # 客户端工厂（加载配置）
│   │
│   ├── prompts/                        # 提示词库
│   │   ├── sys.txt                     # （预留）全局系统提示词
│   │   │
│   │   ├── model1/                     # Model1（对话层）提示词
│   │   │   ├── system.txt              # M1 核心系统提示词
│   │   │   ├── mode1_intro.txt         # Mode1（话题测试）开场白
│   │   │   ├── mode2_intro.txt         # Mode2（自由对话）开场白
│   │   │   │
│   │   │   ├── summary/                # 总结相关
│   │   │   │   └── one_sentence.txt    # 一句话总结提示词
│   │   │   │
│   │   │   └── topics/                 # 话题专用提示词
│   │   │       ├── friendship.txt      # 友谊话题
│   │   │       ├── love.txt            # 爱情话题
│   │   │       ├── work.txt            # 工作话题
│   │   │       └── consumption.txt     # 消费话题
│   │   │
│   │   ├── model2/                     # Model2（观念分析层）提示词
│   │   │   ├── opinion_analysis_mode1.txt  # Mode1 中间分析提示词
│   │   │   ├── opinion_analysis_mode2.txt  # Mode2 中间分析提示词
│   │   │   ├── final_report_mode1.txt      # Mode1 最终报告生成
│   │   │   └── final_report_mode2.txt      # Mode2 最终报告生成
│   │   │
│   │   └── model3/                     # Model3（特质分析层）提示词
│   │       ├── trait_full_report.txt   # 完整特质报告生成
│   │       └── trait_summary.txt       # 一句话特质总结
│   │
│   ├── services/                       # 业务逻辑层
│   │   ├── __init__.py
│   │   ├── chat_service.py             # 聊天服务（三层模型编排）
│   │   ├── model2_service.py           # Model2 服务（观念分析）
│   │   ├── model3_service.py           # Model3 服务（特质分析）
│   │   ├── db_history_manager.py       # 数据库历史管理器
│   │   ├── nickname_service.py         # 昵称业务逻辑（生成/验证/修改）
│   │   └── electrolyte_service.py      # 电解液业务逻辑（签到/消费/充值）
│   │
│   ├── utils/                          # 工具函数
│   │   ├── __init__.py
│   │   ├── text_tools.py               # 文本处理（清洗控制标记/解析标志）
│   │   ├── prompt_loader.py            # 提示词加载器
│   │   ├── validators.py               # 验证器（邮箱/昵称/密码格式）
│   │   └── sensitive_words.py          # 敏感词检查工具
│   │
│   ├── admin_panel.py                  # SQLAdmin 管理后台配置
│   └── config.json                     # LLM 配置文件（API Key/Model）
│
│
├── server/                             # 服务器配置
│   └── nginx配置.conf                  # Nginx 配置文件
│
│
├── main.py                             # FastAPI 主入口
├── requirements.txt                    # Python 依赖列表
├── create_tables.py                    # 数据库表初始化脚本
├── migrate_add_report_fields.py        # 数据库迁移脚本
├── .gitignore.txt                      # Git 忽略规则
└── code_structure.txt                  # 本文档


# ============================================================
# 核心功能模块说明
# ============================================================

【前端】
- chat.html/js      : 主聊天界面（话题选择、对话、历史记录）
- dimgaai.html/js   : 点解页面（特质画像、观念报告集）
- common.css        : 全局样式（宇宙背景、模态框、按钮）

【后端 - API 层】
- auth_api          : 注册/登录/登出 + 每日签到
- user_api          : 个人信息/密码/昵称管理 + 电解液查询
- chat_api          : 流式对话接口（SSE）
- session_api       : 会话管理（列表/详情/删除/完成标记）
- report_api        : 观念报告查询（状态轮询/内容获取）
- traits_api        : 特质画像查询

【后端 - 业务层】
- chat_service      : 三层模型编排（M1对话 + M2分析 + M3特质）
- model2_service    : 观念分析（中间建议 + 最终报告）
- model3_service    : 特质分析（跨会话特质提取）
- nickname_service  : 昵称生成/验证/修改（含敏感词检查）
- electrolyte_service: 电解液签到/消费/充值逻辑

【后端 - 数据层】
- models.py         : 6个核心表（用户/会话/消息/特质/敏感词/昵称历史）
- crud/user         : 用户基础操作（查询/创建/更新/认证）
- crud/nickname     : 昵称操作（更新/历史记录/统计）
- crud/electrolyte  : 电解液操作（查询/增加/扣除）

【LLM 调用层】
- deepseek_client   : DeepSeek API 流式调用
- mock_client       : 测试用假数据生成器
- factory           : 根据 config.json 加载对应客户端

【提示词系统】
- model1/           : 对话生成提示词（系统设定、话题引导）
- model2/           : 观念分析提示词（中间分析、最终报告）
- model3/           : 特质分析提示词（长期特质、一句话总结）


# ============================================================
# 数据库表结构说明
# ============================================================

【users 表】
- 基础字段: id, email, password_hash, nickname, phone_number
- 功能字段: electrolyte_number（电解液余额）, is_plus（Plus会员）
- 系统字段: last_login_date（用于每日签到）, created_at

【sessions 表】
- 基础字段: id, user_id, mode, topic_id
- 状态字段: is_completed（是否完成）, report_ready（报告是否生成）
- 内容字段: opinion_report（观念分析报告文本）
- 软删除: deleted_at（删除时间戳）
- 时间戳: created_at, updated_at

【messages 表】
- 基础字段: id, session_id, role（user/assistant）
- 内容字段: content（消息文本）
- 时间戳: created_at

【trait_profiles 表】
- 基础字段: id, user_id
- 内容字段: summary（一句话特质）, full_report（完整特质报告）
- 时间戳: updated_at

【sensitive_words 表】（新增）
- 基础字段: id, word（敏感词内容）
- 时间戳: created_at

【nickname_history 表】（新增）
- 基础字段: id, user_id
- 内容字段: old_nickname, new_nickname, electrolyte_cost
- 时间戳: created_at


# ============================================================
# 部署相关
# ============================================================

【服务器环境】
- Python: 3.x
- 数据库: MySQL 8.0（通过 aiomysql 异步连接）
- Web服务器: Nginx（反向代理 + 静态资源）
- 应用服务器: Uvicorn（FastAPI）

【Nginx 配置要点】
- 根路径 /         → frontend/html/chat.html
- /dimgaai         → frontend/html/dimgaai.html
- /api/*           → 反向代理到 FastAPI (http://127.0.0.1:8000)
- /admin           → 管理后台（需管理员权限）
- /css/, /js/      → 静态资源直接访问

【启动命令】
```bash
# 创建数据库表
python create_tables.py

# 启动 FastAPI 服务
python main.py
# 或使用 uvicorn
uvicorn main:app --host 0.0.0.0 --port 8000
```

【管理后台】
访问地址: https://metalks.me/admin
权限要求: User.is_admin = True

【重要配置文件】
- backend/config.json       : LLM API 配置
- backend/db/database.py    : 数据库连接字符串
- backend/core/security.py  : JWT 密钥配置


# ============================================================
# 开发规范
# ============================================================

【API 设计规范】
- 认证: 基于 HttpOnly Cookie 的 JWT Token
- 请求体: Pydantic BaseModel 验证
- 响应格式: 统一 JSON（success, message, data）
- 错误处理: HTTPException + 状态码

【代码组织规范】
- API 层: 只负责参数验证、调用服务层、返回响应
- 服务层: 业务逻辑编排、调用 CRUD 层
- CRUD 层: 纯数据库操作、返回 ORM 对象

【提示词管理规范】
- 所有提示词独立文件存储在 backend/prompts/
- 通过 prompt_loader.py 统一加载
- 修改提示词后无需重启服务（动态加载）

【前端开发规范】
- 工具函数统一放在 utils.js
- 每个页面独立 JS 文件（chat.js, dimgaai.js）
- CSS 变量统一在 common.css 定义


# ============================================================
# 新功能开发清单（待实现）
# ============================================================

【Plus 会员系统】
- [ ] 会员订阅流程
- [ ] 昵称修改优惠（Plus 会员免费或折扣）
- [ ] 更多会员专属功能

【个性化设置】
- [ ] 用户偏好配置
- [ ] 对话风格自定义
- [ ] 前端主题切换

【电解液系统完善】
- [ ] 充值功能（支付接口）
- [ ] 消费记录查询
- [ ] 更多消费场景（如 AI 图像生成）

【管理后台增强】
- [ ] 用户管理（封禁、删除）
- [ ] 敏感词批量导入
- [ ] 系统统计面板

【性能优化】
- [ ] Redis 缓存（特质、话题列表）
- [ ] 数据库查询优化（索引、分页）
- [ ] 静态资源 CDN


# ============================================================
# 版本历史
# ============================================================

v1.2.0 (2025-01-12)
- ✨ 新增昵称系统（修改消耗电解液、敏感词过滤、历史记录）
- ✨ 新增电解液系统（每日签到、消费逻辑、余额查询）
- ✨ 新增点解页面（特质画像、观念报告集）
- ✨ 新增用户信息管理 API
- 🎨 优化侧边栏动画和删除确认弹窗
- 🐛 修复会话删除后不跳转问题

v1.1.0 (2025-01-05)
- ✨ 新增管理后台（SQLAdmin）
- ✨ 新增报告后台生成机制
- 🎨 优化前端 UI（历史记录、模态框）
- 🐛 修复多处 Bug

v1.0.0 (2024-12-20)
- 🎉 首次发布
- ✅ 基础对话功能
- ✅ 话题测试模式
- ✅ 自由对话模式
- ✅ 观念分析报告
- ✅ 特质画像生成


# ============================================================
# 联系方式
# ============================================================

项目网站: https://metalks.me
GitHub: https://github.com/[你的仓库]
邮箱: [联系邮箱]

---
最后更新: 2025-01-12
维护者: Metalks 开发团队
