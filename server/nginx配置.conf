# Metalks ä¼˜åŒ–åçš„Nginxé…ç½®
# è§£å†³URLä¸ä¼˜é›…å’Œé™æ€èµ„æºåŠ è½½é—®é¢˜

server {
    listen 443 ssl;
    server_name metalks.me www.metalks.me;

    # é™æ€æ–‡ä»¶æ ¹ç›®å½•
    root /opt/metalks/frontend;

    # SSLé…ç½®
    ssl_certificate /etc/letsencrypt/live/metalks.me/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/metalks.me/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # ===============================================
    # URLè·¯ç”±
    # ===============================================
    
    location /admin {
        proxy_pass http://127.0.0.1:8000;
        proxy_buffering off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_pass_header Set-Cookie;
    }

    # ===============================================
    # ğŸ†• ç®¡ç†åå°é™æ€èµ„æºï¼ˆSQLAdminéœ€è¦ï¼‰
    # ===============================================
    location /admin/statics/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # APIä»£ç†
    location /api/ {
        proxy_pass http://127.0.0.1:8000/;
        proxy_buffering off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_pass_header Set-Cookie;
    }

    # ===============================================
    # ğŸ¯ é¡µé¢è·¯ç”±
    # ===============================================
    
    # ä¸»é¡µï¼šç›´æ¥è®¿é—®æ ¹è·¯å¾„
    location = / {
        try_files /html/chat.html =404;
    }

    #ç™»å½•æ³¨å†Œç•Œé¢ï¼šæ”¯æŒ /auth
    location = /auth {
        try_files /html/auth.html =404;
    }
    
    # èŠå¤©é¡µé¢ï¼šæ”¯æŒ /chat
    location = /chat {
        try_files /html/chat.html =404;
    }
    
    # ç‚¹è§£é¡µé¢ï¼šæ”¯æŒ /dimgaai
    location = /dimgaai {
        try_files /html/dimgaai.html =404;
    }

    # ===============================================
    # ğŸ”§ é™æ€èµ„æºè·¯ç”±
    # ===============================================
    
    # CSSæ–‡ä»¶
    location /css/ {
        alias /opt/metalks/frontend/css/;
        expires 7d;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin *;
    }
    
    # JSæ–‡ä»¶
    location /js/ {
        alias /opt/metalks/frontend/js/;
        expires 7d;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin *;
    }
    
    # HTMLæ–‡ä»¶ï¼ˆå…¼å®¹æ—§è·¯å¾„ï¼‰
    location /html/ {
        alias /opt/metalks/frontend/html/;
        try_files $uri =404;
    }

    # ===============================================
    # ğŸŒ å…¶ä»–é™æ€èµ„æº
    # ===============================================
    
    # å­—ä½“æ–‡ä»¶
    location /fonts/ {
        alias /opt/metalks/frontend/fonts/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # å›¾ç‰‡æ–‡ä»¶
    location /images/ {
        alias /opt/metalks/frontend/images/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # ===============================================
    # ğŸ”’ å®‰å…¨è®¾ç½®
    # ===============================================
    
    # ç¦æ­¢è®¿é—®éšè—æ–‡ä»¶
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # ç¦æ­¢è®¿é—®å¤‡ä»½æ–‡ä»¶
    location ~ ~$ {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# HTTPè‡ªåŠ¨è·³è½¬HTTPS
server {
    listen 80;
    server_name metalks.me www.metalks.me;
    return 301 https://$host$request_uri;
}